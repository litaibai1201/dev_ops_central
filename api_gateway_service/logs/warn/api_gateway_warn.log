2025-09-09 16:34:49,639 - api_gateway - ERROR - auth_api.py:215 - 健康檢查異常: Textual SQL expression 'SELECT 1' should be explicitly declared as text('SELECT 1')
2025-09-09 16:36:32,520 - api_gateway - ERROR - auth_api.py:218 - 健康檢查異常: Textual SQL expression 'SELECT 1' should be explicitly declared as text('SELECT 1')
2025-09-09 16:41:06,775 - api_gateway - ERROR - auth_api.py:229 - 缓存连接检查失敗: Error 61 connecting to 114.33.127.60:6379. Connection refused.
2025-09-09 16:45:22,222 - api_gateway - ERROR - auth_api.py:229 - 缓存连接检查失敗: Error 61 connecting to 114.33.127.60:6379. Connection refused.
2025-09-09 16:47:58,811 - api_gateway - ERROR - common_tools.py:55 - (<models.auth_model.OperUserModel object at 0x1044f9e10>, {'username': 'testuser', 'email': 'test@example.com', 'password_hash': '008c70392e3abfbd0fa47bbc2ed96aa99bd49e159727fcba0f2e6abeb3a9d601', 'full_name': '测试用户', 'phone': '+86 138 0013 8000', 'role': 'user'}): 創建用戶失敗
2025-09-09 16:47:58,813 - api_gateway - ERROR - common_tools.py:56 - Traceback (most recent call last):
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/common/common_tools.py", line 53, in inner
    return func(*args, **kwargs), True
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/models/auth_model.py", line 29, in create_user
    if not user_data.username or not user_data.username.strip():
           ^^^^^^^^^^^^^^^^^^
AttributeError: 'dict' object has no attribute 'username'

2025-09-09 16:47:58,814 - api_gateway - ERROR - auth_controller.py:182 - 用戶註冊失敗: 創建用戶失敗: 創建用戶失敗
2025-09-09 16:47:58,815 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 用戶註冊失敗: 創建用戶失敗: 創建用戶失敗
2025-09-09 16:54:00,727 - api_gateway - ERROR - common_tools.py:55 - (<models.auth_model.OperUserModel object at 0x1047b2a10>, <UserModel (transient 4388210064)>): 創建用戶失敗
2025-09-09 16:54:00,729 - api_gateway - ERROR - common_tools.py:56 - Traceback (most recent call last):
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/common/common_tools.py", line 53, in inner
    return func(*args, **kwargs), True
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/models/auth_model.py", line 48, in create_user
    raise ValueError("用戶名已存在")
ValueError: 用戶名已存在

2025-09-09 16:54:00,802 - api_gateway - ERROR - auth_controller.py:182 - 用戶註冊失敗: 創建用戶失敗: 創建用戶失敗
2025-09-09 16:54:00,805 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 用戶註冊失敗: 創建用戶失敗: 創建用戶失敗
2025-09-09 16:55:33,057 - api_gateway - ERROR - common_tools.py:55 - (<models.auth_model.OperUserModel object at 0x1110e0110>, <UserModel (transient 4583019408)>): 創建用戶失敗, 用戶名已存在
2025-09-09 16:55:33,060 - api_gateway - ERROR - common_tools.py:56 - Traceback (most recent call last):
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/common/common_tools.py", line 53, in inner
    return func(*args, **kwargs), True
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/models/auth_model.py", line 48, in create_user
    raise ValueError("用戶名已存在")
ValueError: 用戶名已存在

2025-09-09 16:55:33,136 - api_gateway - ERROR - auth_controller.py:182 - 用戶註冊失敗: 創建用戶失敗: 創建用戶失敗
2025-09-09 16:55:33,139 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 用戶註冊失敗: 創建用戶失敗: 創建用戶失敗
2025-09-09 16:56:15,598 - api_gateway - ERROR - common_tools.py:55 - (<models.auth_model.OperUserModel object at 0x1065df090>, <UserModel (transient 4437481808)>): 創建用戶失敗, 用戶名已存在
2025-09-09 16:56:15,601 - api_gateway - ERROR - common_tools.py:56 - Traceback (most recent call last):
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/common/common_tools.py", line 53, in inner
    return func(*args, **kwargs), True
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/models/auth_model.py", line 48, in create_user
    raise ValueError("用戶名已存在")
ValueError: 用戶名已存在

2025-09-09 16:56:15,685 - api_gateway - ERROR - auth_controller.py:182 - 用戶註冊失敗: 創建用戶失敗: 創建用戶失敗, 用戶名已存在
2025-09-09 16:56:15,688 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 用戶註冊失敗: 創建用戶失敗: 創建用戶失敗, 用戶名已存在
2025-09-09 16:59:21,292 - api_gateway - ERROR - common_tools.py:59 - (<models.auth_model.OperUserModel object at 0x104d75e10>, <UserModel (transient 4341670352)>): 用戶名已存在
2025-09-09 16:59:21,294 - api_gateway - ERROR - common_tools.py:60 - Traceback (most recent call last):
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/common/common_tools.py", line 53, in inner
    return func(*args, **kwargs), True
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/models/auth_model.py", line 48, in create_user
    raise ValueError("用戶名已存在")
ValueError: 用戶名已存在

2025-09-09 16:59:21,372 - api_gateway - ERROR - auth_controller.py:182 - 用戶註冊失敗: 創建用戶失敗: 用戶名已存在
2025-09-09 16:59:21,374 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 用戶註冊失敗: 創建用戶失敗: 用戶名已存在
2025-09-09 17:02:45,577 - api_gateway - ERROR - auth_controller.py:301 - 登錄異常: Error 61 connecting to 114.33.127.60:6379. Connection refused.
2025-09-09 17:02:45,578 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 登錄失敗，系統內部錯誤
2025-09-09 17:06:58,446 - api_gateway - ERROR - common_tools.py:59 - (<models.auth_model.OperRefreshTokenModel object at 0x103f95910>, {'user_id': 1, 'token_hash': '4f8866c9f7a690a4bf19c427f9c96fab9483d5587737ef081aca3d1d6ef87988', 'expires_at': '2025-09-09 17:06:58', 'device_info': '桌面設備', 'ip_address': '127.0.0.1'}): 創建刷新令牌失敗, Class 'builtins.dict' is not mapped
2025-09-09 17:06:58,454 - api_gateway - ERROR - common_tools.py:60 - Traceback (most recent call last):
  File "/Users/lidong/anaconda3/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 3473, in add
    state = attributes.instance_state(instance)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'dict' object has no attribute '_sa_instance_state'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/common/common_tools.py", line 53, in inner
    return func(*args, **kwargs), True
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/models/auth_model.py", line 143, in create_refresh_token
    db.session.add(token_data)
  File "/Users/lidong/anaconda3/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py", line 378, in add
    return self._proxied.add(instance, _warn=_warn)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/lidong/anaconda3/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 3475, in add
    raise exc.UnmappedInstanceError(instance) from err
sqlalchemy.orm.exc.UnmappedInstanceError: Class 'builtins.dict' is not mapped

2025-09-09 17:06:58,527 - api_gateway - ERROR - auth_controller.py:182 - 用戶登錄失敗: 創建刷新令牌失敗: 創建刷新令牌失敗, Class 'builtins.dict' is not mapped
2025-09-09 17:06:58,530 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 用戶登錄失敗: 創建刷新令牌失敗: 創建刷新令牌失敗, Class 'builtins.dict' is not mapped
2025-09-10 08:09:43,373 - api_gateway - ERROR - common_tools.py:59 - (<models.auth_model.OperUserModel object at 0x1062d9b10>, <UserModel (transient 4434749328)>): 創建用戶失敗, 郵箱已被註冊
2025-09-10 08:09:43,376 - api_gateway - ERROR - common_tools.py:60 - Traceback (most recent call last):
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/common/common_tools.py", line 53, in inner
    return func(*args, **kwargs), True
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/models/auth_model.py", line 50, in create_user
    raise ValueError("郵箱已被註冊")
ValueError: 郵箱已被註冊

2025-09-10 08:09:43,444 - api_gateway - ERROR - auth_controller.py:175 - 用戶註冊失敗: 創建用戶失敗: 創建用戶失敗, 郵箱已被註冊
2025-09-10 08:09:43,446 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 用戶註冊失敗: 創建用戶失敗: 創建用戶失敗, 郵箱已被註冊
2025-09-10 08:10:11,844 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 用戶名或密碼錯誤
2025-09-10 08:11:53,588 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌無效
2025-09-10 08:12:53,157 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌無效
2025-09-10 08:13:54,225 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌無效
2025-09-10 08:14:04,837 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌無效
2025-09-10 08:14:25,084 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌無效
2025-09-10 08:20:27,038 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌無效
2025-09-10 08:20:45,563 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌已過期或無效
2025-09-10 08:20:49,401 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌已過期或無效
2025-09-10 08:21:15,190 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌已過期或無效
2025-09-10 08:33:19,230 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌已過期或無效
2025-09-10 08:33:20,776 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌已過期或無效
2025-09-10 08:33:57,296 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌已過期或無效
2025-09-10 09:05:03,282 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌已過期或無效
2025-09-10 09:05:59,931 - api_gateway - ERROR - auth_controller.py:367 - 刷新令牌異常: cannot access local variable 'current_time' where it is not associated with a value
2025-09-10 09:05:59,932 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌失敗
2025-09-10 09:06:31,912 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌已過期或無效
2025-09-10 09:06:47,023 - api_gateway - ERROR - auth_controller.py:367 - 刷新令牌異常: cannot access local variable 'current_time' where it is not associated with a value
2025-09-10 09:06:47,023 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌失敗
2025-09-10 09:07:15,060 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌已過期或無效
2025-09-10 09:07:45,485 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌已過期或無效
2025-09-10 09:09:39,252 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌已過期或無效
2025-09-10 09:16:56,614 - api_gateway - ERROR - auth_controller.py:365 - 刷新令牌異常: 'AuthController' object has no attribute '_refresh_transaction'
2025-09-10 09:16:56,615 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌失敗
2025-09-10 10:01:03,390 - api_gateway - ERROR - common_tools.py:59 - (<models.auth_model.OperUserModel object at 0x1111b00d0>, <UserModel (transient 4632226576)>): 創建用戶失敗, 用戶名已存在
2025-09-10 10:01:03,393 - api_gateway - ERROR - common_tools.py:60 - Traceback (most recent call last):
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/common/common_tools.py", line 53, in inner
    return func(*args, **kwargs), True
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/lidong/Desktop/projects/dev_ops_central/api_gateway_service/models/auth_model.py", line 48, in create_user
    raise ValueError("用戶名已存在")
ValueError: 用戶名已存在

2025-09-10 10:01:03,468 - api_gateway - ERROR - auth_controller.py:175 - 用戶註冊失敗: 創建用戶失敗: 創建用戶失敗, 用戶名已存在
2025-09-10 10:01:03,471 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 用戶註冊失敗: 創建用戶失敗: 創建用戶失敗, 用戶名已存在
2025-09-10 10:44:17,551 - api_gateway - WARNING - auth_api.py:43 - API操作失败: 刷新令牌已過期或無效
